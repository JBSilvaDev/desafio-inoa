{% extends 'base.html' %}
{% load static %}
{% block titulo %}
Detalhes do Ativo
{% endblock %}
{% block body %}

<body>
    <div class="container mt-4">
        <h1>Detalhamento de {{ ativo_user.ativo.nome_empresa }}</h1>

        <section class="ativos-list">
            <table class="table">
                <thead class="thead-light">
                    <tr>
                        <th scope="col">Cod Ativo</th>
                        <th scope="col">Empresa</th>
                        <th scope="col">Valor</th>
                        <th scope="col">Volume</th>
                        <th scope="col">Variação Esperada</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ ativo_user.ativo.cod_ativo }}</td>
                        <td>{{ ativo_user.ativo.nome_empresa }}</td>
                        <td>R$ {{ stock_data.regularMarketPrice|default:"N/A" }}</td>
                        <td>{{ stock_data.regularMarketVolume|default:"N/A" }}</td>
                        <td>{{ stock_data.regularMarketChangePercent|default:"N/A" }}%</td>
                    </tr>
                </tbody>
            </table>
            {% if user.is_authenticated %}
            <form method="POST" action="{% url 'ativos_user:update_ativo_config' ativo_user.id %}"> {# Ação de update_wallet não existe mais, usar update_ativo_config #}
                {% csrf_token %}
                {# A lógica de is_monitored não é mais relevante aqui, pois o ativo_user já existe #}
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#configModal-{{ ativo_user.id }}">
                    Configurar Monitoramento
                </button>
            </form>
            {% endif %}
        </section>
    </div>

    <div id="plot"></div>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


    <script>
        // A função updateChart não será mais chamada via AJAX para buscar dados,
        // pois os dados já vêm no contexto da view.
        // Apenas renderizar o gráfico uma vez com os dados iniciais.
        $(document).ready(function () {
            const chartData = JSON.parse('{{ chart_data_json|escapejs }}');

            Plotly.newPlot('plot', [{
                x: chartData.x.map(dateString => new Date(dateString)),
                y: chartData.y,
                type: 'line',
                name: chartData.title,
            }], {
                title: chartData.title,
                xaxis: {
                    title: 'Data'
                },
                yaxis: {
                    title: 'Preço (R$)'
                }
            });
        });
    </script>

    <!-- Modal para configuração do ativo (copiado de favoritos.html) -->
    <div class="modal fade" id="configModal-{{ ativo_user.id }}" tabindex="-1" aria-labelledby="configModalLabel-{{ ativo_user.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalLabel-{{ ativo_user.id }}">Configurar {{ ativo_user.ativo.cod_ativo }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'ativos_user:update_ativo_config' ativo_user.id %}" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ ativo_user.form.limite_superior.label_tag }}
                            {{ ativo_user.form.limite_superior }}
                        </div>
                        <div class="mb-3">
                            {{ ativo_user.form.limite_inferior.label_tag }}
                            {{ ativo_user.form.limite_inferior }}
                        </div>
                        <div class="mb-3">
                            {{ ativo_user.form.intervalo_verificacao.label_tag }}
                            {{ ativo_user.form.intervalo_verificacao }}
                        </div>
                        <div class="mb-3 form-check">
                            {{ ativo_user.form.favorito }}
                            {{ ativo_user.form.favorito.label_tag }}
                        </div>
                        <div class="mb-3 form-check">
                            {{ ativo_user.form.em_carteira }}
                            {{ ativo_user.form.em_carteira.label_tag }}
                        </div>
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</body>

{% endblock %}