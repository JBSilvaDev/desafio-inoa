{% extends 'base.html' %}
{% load static %}
{% block titulo %}
Detalhes do Ativo
{% endblock %}
{% block body %}

<body>
    <div class="container mt-4">
        <h1>Detalhamento de {{ ativo_user.ativo.nome_empresa }}</h1>

        <section class="ativos-list">
            <table class="table">
                <thead class="thead-light">
                    <tr>
                        <th scope="col">Cod Ativo</th>
                        <th scope="col">Empresa</th>
                        <th scope="col">Valor</th>
                        <th scope="col">Volume</th>
                        <th scope="col">Variação Esperada</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ ativo_user.ativo.cod_ativo }}</td>
                        <td>{{ ativo_user.ativo.nome_empresa }}</td>
                        <td>R$ {{ stock_data.regularMarketPrice|default:"N/A" }}</td>
                        <td>{{ stock_data.regularMarketVolume|default:"N/A" }}</td>
                        <td>{{ stock_data.regularMarketChangePercent|default:"N/A" }}%</td>
                    </tr>
                </tbody>
            </table>
            {% if user.is_authenticated %}
            <form method="POST" action="{% url 'ativos_user:update_ativo_config' ativo_user.id %}">
                {% csrf_token %}
                
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#configModal-{{ ativo_user.id }}">
                    Configurar Monitoramento
                </button>
            </form>
            {% endif %}
        </section>
    </div>

    <div id="chart-container" class="container mt-4">
        <div class="btn-group" role="group" aria-label="Intervalos do Gráfico">
            <button type="button" class="btn btn-secondary" data-range="5d" data-interval="1d">Dia</button>
            <button type="button" class="btn btn-secondary" data-range="1mo" data-interval="1wk">Semana</button>
            <button type="button" class="btn btn-secondary" data-range="1mo" data-interval="1d">Mês</button>
            <button type="button" class="btn btn-secondary" data-range="3mo" data-interval="1d">3 Meses</button>
        </div>
        <div id="plot-loading" style="display: none; text-align: center; padding: 20px;">
            <p>Carregando...</p>
        </div>
        <div id="plot"></div>
    </div>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script>
        $(document).ready(function () {
            const initialChartData = JSON.parse('{{ chart_data_json|escapejs }}');
            const plotDiv = document.getElementById('plot');

            function plotChart(chartData) {
                if (chartData && chartData.x && chartData.x.length > 0 && chartData.y && chartData.y.length > 0) {
                    Plotly.newPlot(plotDiv, [{
                        x: chartData.x.map(dateString => new Date(dateString * 1000)),
                        y: chartData.y,
                        type: 'line',
                        name: chartData.title,
                    }], {
                        title: chartData.title,
                        xaxis: { title: 'Data' },
                        yaxis: { title: 'Preço (R$)' }
                    });
                } else {
                    $(plotDiv).html('<center><p class="text-warning">Não há dados históricos disponíveis para exibir o gráfico.</p></center>');
                }
            }

            plotChart(initialChartData);

            $('.btn-group .btn').click(function () {
                const range = $(this).data('range');
                const interval = $(this).data('interval');
                const url = `{% url 'ativos_user:detalhes_ativo' ativo_user.id %}?range=${range}&interval=${interval}`;

                $('#plot').hide();
                $('#plot-loading').show();

                $.ajax({
                    url: url,
                    type: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function (data) {
                        plotChart(data);
                        $('#plot-loading').hide();
                        $('#plot').show();
                    },
                    error: function (error) {
                        console.error('Erro ao buscar dados do gráfico:', error);
                        $('#plot-loading').hide();
                        $('#plot').html('<center><p class="text-danger">Erro ao carregar os dados do gráfico.</p></center>').show();
                    }
                });
            });
        });
    </script>

    <!-- Modal para configuração do ativo (copiado de favoritos.html) -->
    <div class="modal fade" id="configModal-{{ ativo_user.id }}" tabindex="-1" aria-labelledby="configModalLabel-{{ ativo_user.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalLabel-{{ ativo_user.id }}">Configurar {{ ativo_user.ativo.cod_ativo }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'ativos_user:update_ativo_config' ativo_user.id %}" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ form.limite_superior.label_tag }} 
                            {{ form.limite_superior }} 
                        </div>
                        <div class="mb-3">
                            {{ form.limite_inferior.label_tag }} 
                            {{ form.limite_inferior }} 
                        </div>
                        <div class="mb-3">
                            {{ form.intervalo_verificacao.label_tag }} 
                            {{ form.intervalo_verificacao }} 
                        </div>
                        <div class="mb-3 form-check">
                            {{ form.favorito }} 
                            {{ form.favorito.label_tag }} 
                        </div>
                        <div class="mb-3 form-check">
                            {{ form.em_carteira }} 
                            {{ form.em_carteira.label_tag }} 
                        </div>
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</body>

{% endblock %}