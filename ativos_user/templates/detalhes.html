{% extends 'base.html' %}
{% load static %}
{% block titulo %}
Detalhes do Ativo
{% endblock %}
{% block body %}

<body>
    <div class="container mt-4">
        <h1>Detalhamento de {{ ativo_user.ativo.nome_empresa }}</h1>

        <section class="ativos-list">
            <table class="table">
                <thead class="thead-light">
                    <tr>
                        <th scope="col">Cod Ativo</th>
                        <th scope="col">Empresa</th>
                        <th scope="col">Valor</th>
                        <th scope="col">Volume</th>
                        <th scope="col">Variação Esperada</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ ativo_user.ativo.cod_ativo }}</td>
                        <td>{{ ativo_user.ativo.nome_empresa }}</td>
                        <td id="stock-price">R$ {{ stock_data.regularMarketPrice|default:"N/A" }}</td>
                        <td id="stock-volume">{{ stock_data.regularMarketVolume|default:"N/A" }}</td>
                        <td id="stock-change-percent">{{ stock_data.regularMarketChangePercent|default:"N/A" }}%</td>
                    </tr>
                </tbody>
            </table>
            {% if user.is_authenticated %}
            <form method="POST" action="{% url 'ativos_user:update_ativo_config' ativo_user.id %}">
                {% csrf_token %}
                
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#configModal-{{ ativo_user.id }}">
                    Configurar Monitoramento
                </button>
            </form>
            {% endif %}
        </section>
    </div>

    <div id="chart-container" class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="api-switcher" data-bs-toggle="dropdown" aria-expanded="false">
                    API: <span id="api-name">brapi</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="api-switcher">
                    <li><a class="dropdown-item" href="#" data-api="brapi">brapi</a></li>
                    <li><a class="dropdown-item" href="#" data-api="alpha">Alpha Vantage</a></li>
                </ul>
            </div>
            <div class="btn-group" role="group" aria-label="Intervalos do Gráfico">
                <button type="button" class="btn btn-secondary" id="btn-hora" data-interval="60min">Hora</button>
                <button type="button" class="btn btn-secondary" data-range="5d" data-interval="1d">Dia</button>
                <button type="button" class="btn btn-secondary" data-range="1mo" data-interval="1wk">Semana</button>
                <button type="button" class="btn btn-secondary active" data-range="1mo" data-interval="1d">Mês</button>
                <button type="button" class="btn btn-secondary" data-range="3mo" data-interval="1d">3 Meses</button>
            </div>
        </div>
        <div id="plot-loading" style="display: none; text-align: center; padding: 20px;">
            <p>Carregando...</p>
        </div>
        <div id="plot" style="width: 100%; height: 450px;"></div>
    </div>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script>
        $(document).ready(function () {
            const initialChartData = JSON.parse('{{ chart_data_json|escapejs }}');
            const plotDiv = document.getElementById('plot');
            let currentApi = '{{ api_source }}';

            function plotChart(chartData) {
                console.log('Chart data:', chartData);
                if (chartData && chartData.error) {
                    let errorMessage = chartData.error;
                    if (typeof errorMessage === 'string' && errorMessage.includes('Thank you for using Alpha Vantage')) {
                        errorMessage = 'Limite da API Alpha Vantage atingido. Por favor, tente novamente mais tarde ou mude para a API brapi.';
                    }
                    $(plotDiv).html('<center><p class="text-danger">' + errorMessage + '</p></center>');
                } else if (chartData && chartData.x && chartData.x.length > 0 && chartData.y && chartData.y.length > 0) {
                    
                    const dates = chartData.x.map(d => (typeof d === 'string' ? new Date(d) : new Date(d * 1000)));
                    const traces = [];
                    let layout = {
                        title: chartData.title,
                        xaxis: { title: 'Data', automargin: true },
                        yaxis: { title: 'Preço (R$)', automargin: true },
                        autosize: true,
                        legend: {x: 0.01, y: 0.99, xanchor: 'left', yanchor: 'top'}
                    };

                    // Traço do preço (sempre existe)
                    traces.push({
                        x: dates,
                        y: chartData.y,
                        type: 'line',
                        name: 'Fechamento',
                        line: { color: '#1f77b4', width: 2 }
                    });

                    // Se houver dados de volume (API Alpha Vantage)
                    if (chartData.volume && chartData.volume.length > 0) {
                        traces.push({
                            x: dates,
                            y: chartData.volume,
                            type: 'bar',
                            name: 'Volume',
                            yaxis: 'y2',
                            marker: { color: '#888888', opacity: 0.3 }
                        });

                        layout.yaxis2 = {
                            title: 'Volume',
                            overlaying: 'y',
                            side: 'right',
                            showgrid: false,
                            automargin: true
                        };
                        layout.title = `${chartData.title} (Alpha Vantage)`;
                    } else {
                        layout.title = `${chartData.title} (brapi)`;
                    }

                    Plotly.newPlot(plotDiv, traces, layout, { responsive: true });

                } else {
                    $(plotDiv).html('<center><p class="text-warning">Não há dados históricos disponíveis para exibir o gráfico.</p></center>');
                }
            }

            function updateTable(stockData) {
                $('#stock-price').text('R$ ' + (stockData.regularMarketPrice || 'N/A'));
                $('#stock-volume').text(stockData.regularMarketVolume || 'N/A');
                $('#stock-change-percent').text((stockData.regularMarketChangePercent || 'N/A') + '%');
            }

            function updateHoraButtonState() {
                $('#btn-hora').prop('disabled', currentApi === 'brapi');
            }

            plotChart(initialChartData);
            updateHoraButtonState();
            $('#api-name').text(currentApi === 'alpha' ? 'Alpha Vantage' : 'brapi');


            $('.dropdown-item').click(function (e) {
                e.preventDefault();
                currentApi = $(this).data('api');
                $('#api-name').text($(this).text());
                updateHoraButtonState();
                // Disparar um clique no botão de intervalo ativo para recarregar o gráfico
                $('.btn-group .btn.active').click();
            });

            $('.btn-group .btn').click(function () {
                const range = $(this).data('range');
                const interval = $(this).data('interval');
                let url = `{% url 'ativos_user:detalhes_ativo' ativo_user.id %}?api=${currentApi}&interval=${interval}`;

                if (currentApi === 'brapi') {
                    url += `&range=${range}`;
                }

                $('#plot').hide();
                $('#plot-loading').show();

                $.ajax({
                    url: url,
                    type: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function (data) {
                        plotChart(data.chart_data);
                        updateTable(data.stock_data);
                        $('#plot-loading').hide();
                        $('#plot').show();
                    },
                    error: function (error) {
                        console.error('Erro ao buscar dados do gráfico:', error);
                        $('#plot-loading').hide();
                        $('#plot').html('<center><p class="text-danger">Erro ao carregar os dados do gráfico.</p></center>').show();
                    }
                });

                // Lidar com a classe 'active' para os botões
                $('.btn-group .btn').removeClass('active');
                $(this).addClass('active');
            });

            $(window).on('resize', function() {
                Plotly.Plots.resize(plotDiv);
            });
        });
    </script>

    <!-- Modal para configuração do ativo (copiado de favoritos.html) -->
    <div class="modal fade" id="configModal-{{ ativo_user.id }}" tabindex="-1" aria-labelledby="configModalLabel-{{ ativo_user.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configModalLabel-{{ ativo_user.id }}">Configurar {{ ativo_user.ativo.cod_ativo }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'ativos_user:update_ativo_config' ativo_user.id %}" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ form.limite_superior.label_tag }} 
                            {{ form.limite_superior }} 
                        </div>
                        <div class="mb-3">
                            {{ form.limite_inferior.label_tag }} 
                            {{ form.limite_inferior }} 
                        </div>
                        <div class="mb-3">
                            {{ form.intervalo_verificacao.label_tag }} 
                            {{ form.intervalo_verificacao }} 
                        </div>
                        <div class="mb-3 form-check">
                            {{ form.favorito }} 
                            {{ form.favorito.label_tag }} 
                        </div>
                        <div class="mb-3 form-check">
                            {{ form.em_carteira }} 
                            {{ form.em_carteira.label_tag }} 
                        </div>
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</body>

{% endblock %}